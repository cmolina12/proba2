# Importemos los datos
Datos <- read.csv("DatosClase9.csv")

# Hallemos el modelo de regresión lineal
# La función lm nos permite hacer esto. Recibe Y~X. 
# Por defecto incluye intercepto. Podríamos quitarlo agregando -1 a la fórmula.
# El . implica tomar todas las columnas (a excepción de la que usamos como Y)
modelo_completo = lm(TiempoEntrega_min~., data=Datos)
summary(modelo_completo)

# De este modelo podemos extraer información relevante, tal como
n = nobs(modelo_completo) # número de observaciones de Y
modelo_completo$coefficients # betas
p_completo = length(modelo_completo$coefficients) # número de betas
k_completo = p_completo-1 # número de variables explicativas
vcov(modelo_completo) # matriz de varianzas y covarianzas de los betas
modelo_completo$residuals # residuales del modelo

# Ahora, vamos a calcular las sumas de cuadrados
SST = sum((Datos$TiempoEntrega_min - mean(Datos$TiempoEntrega_min))^2)
SSE_completo = sum(modelo_completo$residuals^2)
SSR_completo = SST - SSE_completo

################################################################################
# 1) ¿Es correcto remover simultáneamente las variables peso y valor del pedido?

# La hipótesis nula de la prueba a realizar es Beta_peso = Beta_ValorPedido = 0

# Debemos hallar la suma de cuadrados extra, es decir, la diferencia entre los
# SSR del modelo completo y el modelo reducido (o, lo que es equivalente, la 
# diferencia entre los SSE del modelo reducido y el modelo completo)

# Estimemos el modelo que resulta cuando H0 es cierta:
modelo_reducido = lm(TiempoEntrega_min~.-Peso_kg-ValorPedido_COP,data=Datos)
summary(modelo_reducido)

# Ahora, hallemos su SSR
# Sabemos que el SST no cambia
SSE_reducido = sum(modelo_reducido$residuals^2)
SSR_reducido = SST - SSE_reducido
# Note que SSE_reducido > SSE_completo y SSR_reducido < SSR_completo

# Hallemos el SS Extra (note que el resultado de las dos líneas de código
# siguientes es el mismo)
SSExtra = SSR_completo-SSR_reducido
SSExtra = SSE_reducido-SSE_completo

# Los grados de libertad extra son la diferencia entre los glR o los glE
# Los glR del completo son k_completo. Ahora, los del reducido serán 2 menos,
# pues en la hipótesis nula estamos mandando dos betas a 0
glExtra = 2

# Hallamos el MSExtra como el cociente entre SS y gl
MSExtra = SSExtra / glExtra

# Finalmente, necesitamos el MSE del modelo completo, que es el denominador del EP
MSE_completo = SSE_completo / (n-p_completo)

# Ahora si, calculamos el EP
EP = MSExtra/MSE_completo

# y el valor crítico
F_critico = qf(0.95,2,n-p_completo)

EP > F_critico # Esto es falso, por ende, no se rechaza H0.
pf(EP,2,n-p_completo,lower.tail=FALSE) # p value (da alto, no rechazo H0)
# SÍ es correcto remover peso y valor del pedido del modelo.


# Todo lo anterior lo podríamos haber hecho directamente con la función anova
# Como parámetros, pasamos el modelo reducido y el modelo completo
anova(modelo_reducido,modelo_completo)


################################################################################
# 2) ¿Las condiciones externas (lluvia y tráfico) influyen en conjunto sobre
#     el tiempo de entrega?


# La hipótesis nula de la prueba a realizar es Beta_Lluvia = Beta_Trafico = 0
# Así, el modelo que resulta es 
modelo_reducido2 = lm(TiempoEntrega_min~.-Lluvia_mm-Trafico_idx,data=Datos)
summary(modelo_reducido2)

# Hagamos la prueba directamente con la función anova
anova(modelo_reducido2,modelo_completo)
# Hay evidencia para rechazar H0 (p value pequeño).
# Las condiciones externas SÍ influyen


################################################################################
# 3) Comparar dos modelos

# Estimemos los dos modelos presentados en la diapositiva
modelo_1 = lm(TiempoEntrega_min~Distancia_km+Items_n,data=Datos)
summary(modelo_1)

modelo_2 = lm(TiempoEntrega_min~Distancia_km+Items_n
              +Lluvia_mm+Peso_kg+Trafico_idx,data=Datos)
summary(modelo_2)

# Note que el modelo_2 sería el completo y el _1 el reducido en este caso

# La hipótesis nula sería que Beta_Lluvia = Beta_Peso = 0

# Hagamos la prueba
anova(modelo_1,modelo_2)
# Hay evidencia para rechazar H0 (p value pequeño).
# El modelo 2 es mejor


